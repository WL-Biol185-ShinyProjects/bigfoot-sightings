```{r}

library(shiny)
library(ggplot2)
library(lubridate)
library(dplyr)

# Function to get moon phase name
get_phase_name <- function(phase) {
  if (phase < 0.125) {
    return("New Moon")
  } else if (phase < 0.25) {
    return("Waxing Crescent")
  } else if (phase < 0.375) {
    return("First Quarter")
  } else if (phase < 0.5) {
    return("Waxing Gibbous")
  } else if (phase < 0.625) {
    return("Full Moon")
  } else if (phase < 0.75) {
    return("Waning Gibbous")
  } else if (phase < 0.875) {
    return("Last Quarter")
  } else {
    return("Waning Crescent")
  }
}

# Function to create moon visualization with count
create_moon_plot <- function(phase, sighting_count) {
  # Create circle for moon
  theta <- seq(0, 2*pi, length.out = 100)
  x <- cos(theta)
  y <- sin(theta)
  
  # Calculate illumination
  illum_phase <- phase * 2 * pi
  
  # Create the illuminated and dark parts
  if (phase < 0.5) {
    # Waxing (right side illuminated)
    x_illum <- cos(theta) * cos(illum_phase)
  } else {
    # Waning (left side illuminated)
    x_illum <- -cos(theta) * cos(illum_phase)
  }
  
  df_circle <- data.frame(x = x, y = y)
  df_illum <- data.frame(x = x_illum, y = y)
  
  p <- ggplot() +
    # Dark side of moon
    geom_polygon(data = df_circle, aes(x = x, y = y), 
                 fill = "#2c3e50", color = "#7f8c8d", size = 2) +
    # Illuminated side
    geom_polygon(data = df_illum, aes(x = x, y = y), 
                 fill = "#f9ca24", color = "#7f8c8d", size = 1) +
    # Add sighting count
    annotate("text", x = 0, y = -1.5, 
             label = paste("Sightings:", sighting_count), 
             color = "#f9ca24", size = 8, fontface = "bold") +
    coord_fixed() +
    theme_void() +
    theme(
      plot.background = element_rect(fill = "#0a0e27", color = NA),
      panel.background = element_rect(fill = "#0a0e27", color = NA)
    ) +
    xlim(-1.2, 1.2) +
    ylim(-1.7, 1.2)
  
  return(p)
}
```

